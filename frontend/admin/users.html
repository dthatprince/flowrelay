<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Manage Users - Flow Relay</title>
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link id="pagestyle" href="../assets/css/soft-ui-dashboard.min.css?v=1.0.7" rel="stylesheet" />
  <link href="../assets/css/custom.css" rel="stylesheet" />
</head>
<style>
  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    }
</style>
<body class="g-sidenav-show bg-gray-100">
  <!-- Sidebar -->
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0" href="dashboard.html">
        <span class="ms-1 font-weight-bold">Admin Panel</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0">
    <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="dashboard.html">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-home text-primary"></i>
            </div>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="approvals.html">
            <div
              class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-user-check text-warning"></i>
            </div>
            <span class="nav-link-text ms-1">Account Approvals Requests</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="users.html">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-users text-info"></i>
            </div>
            <span class="nav-link-text ms-1">Manage Users</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="drivers.html">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-car text-success"></i>
            </div>
            <span class="nav-link-text ms-1">Manage Drivers</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="offers.html">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-truck text-warning"></i>
            </div>
            <span class="nav-link-text ms-1">Manage Offers</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Account</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link logout-btn" href="#">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fas fa-sign-out-alt text-danger"></i>
            </div>
            <span class="nav-link-text ms-1">Logout</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" navbar-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="dashboard.html">Dashboard</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Users</li>
          </ol>
          <h6 class="font-weight-bolder mb-0">Manage Users</h6>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
            <div class="input-group">
              <span class="input-group-text text-body"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" placeholder="Search users..." id="searchInput">
            </div>
          </div>
          <ul class="navbar-nav justify-content-end">
            <li class="nav-item d-flex align-items-center">
              <a href="#" class="nav-link text-body font-weight-bold px-0">
                <i class="fa fa-user me-sm-1"></i>
                <span class="d-sm-inline d-none user-name">Admin</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <!-- Filter Buttons -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-primary active" data-filter="all">All Users</button>
            <button type="button" class="btn btn-sm btn-outline-info" data-filter="admin">Admins</button>
            <button type="button" class="btn btn-sm btn-outline-success" data-filter="client">Clients</button>
            <button type="button" class="btn btn-sm btn-outline-warning" data-filter="verified">Verified</button>
            <button type="button" class="btn btn-sm btn-outline-danger" data-filter="unverified">Unverified</button>
          </div>
        </div>
      </div>

      <!-- Users Table -->
      <div class="row">
        <div class="col-12">
          <div class="card mb-4">
            <div class="card-header pb-0">
              <h6>All Users</h6>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">User</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Company</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Contact</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Role</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Email Verification Status</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Joined</th>
                      <th class="text-secondary opacity-7"></th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody">
                    <tr>
                      <td colspan="7" class="text-center py-4">Loading users...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Edit User Modal -->
  <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editUserForm">
            <input type="hidden" id="editUserId">
            <div class="mb-3">
              <label for="editEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="editEmail" required>
            </div>
            <div class="mb-3">
              <label for="editCompanyName" class="form-label">Company Name</label>
              <input type="text" class="form-control" id="editCompanyName">
            </div>
            <div class="mb-3">
              <label for="editAddress" class="form-label">Address</label>
              <input type="text" class="form-control" id="editAddress">
            </div>
            <div class="mb-3">
              <label for="editPhoneNumber" class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="editPhoneNumber">
            </div>
            <div class="mb-3">
              <label for="editCompanyRepresentative" class="form-label">Company Representative</label>
              <input type="text" class="form-control" id="editCompanyRepresentative">
            </div>
            <div class="mb-3">
              <label for="editEmergencyPhone" class="form-label">Emergency Phone</label>
              <input type="tel" class="form-control" id="editEmergencyPhone">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveUserBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View User Modal -->
  <div class="modal fade" id="viewUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">User Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="userDetailsContent">
          Loading...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../assets/js/soft-ui-dashboard.min.js?v=1.0.7"></script>
  
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/utils.js"></script>
  
  <script>
    // Check authentication
    if (!auth.requireAdmin()) {
      window.location.href = '../index.html';
    }

    let allUsers = [];
    let editUserModal, viewUserModal;

    // Load all users
    async function loadUsers() {
      try {
        allUsers = await api.getAllUsers();
        displayUsers(allUsers);
      } catch (error) {
        showToast('Failed to load users', 'error');
      }
    }

    // Display users in table
    function displayUsers(users) {
      const tbody = document.getElementById('usersTableBody');
      
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No users found</td></tr>';
        return;
      }
      
      tbody.innerHTML = users.map(user => `
        <tr data-role="${user.role}" data-verified="${user.is_verified}">
          <td>
            <div class="d-flex px-2 py-1">
              <div>
                <div class="icon icon-shape icon-sm border-radius-md bg-gradient-${user.role === 'admin' ? 'danger' : 'info'} d-flex align-items-center justify-content-center me-2">
                  <i class="fas fa-${user.role === 'admin' ? 'user-shield' : 'user'} text-white"></i>
                </div>
              </div>
              <div class="d-flex flex-column justify-content-center">
                <h6 class="mb-0 text-sm">${user.email}</h6>
                <p class="text-xs text-secondary mb-0">ID: ${user.id}</p>
              </div>
            </div>
          </td>
          <td>
            <p class="text-xs font-weight-bold mb-0">${user.company_name || '-'}</p>
            <p class="text-xs text-secondary mb-0">${user.company_representative || '-'}</p>
          </td>
          <td>
            <p class="text-xs font-weight-bold mb-0">${user.phone_number || '-'}</p>
            <p class="text-xs text-secondary mb-0">${user.address || '-'}</p>
          </td>
          <td class="align-middle text-center text-sm">
            <span class="badge badge-sm bg-gradient-${user.role === 'admin' ? 'danger' : 'info'}">${user.role.toUpperCase()}</span>
          </td>
          <td class="align-middle text-center">
            <span class="badge badge-sm bg-gradient-${user.is_verified === 'true' ? 'success' : 'warning'}">
              ${user.is_verified === 'true' ? 'Verified' : 'Unverified'}
            </span>
          </td>
          <td class="align-middle text-center">
            <span class="text-secondary text-xs font-weight-bold">${formatDate(user.created_at)}</span>
          </td>
          <td class="align-middle">
            <button class="btn btn-link text-secondary mb-0" onclick="viewUser(${user.id})">
              <i class="fas fa-eye text-xs"></i>
            </button>
            <button class="btn btn-link text-primary mb-0" onclick="editUser(${user.id})">
              <i class="fas fa-edit text-xs"></i>
            </button>
            <button class="btn btn-link text-danger mb-0" onclick="deleteUser(${user.id}, '${user.email}')">
              <i class="fas fa-trash text-xs"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    // View user details
    function viewUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      const content = `
        <div class="row">
          <div class="col-md-6">
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Role:</strong> <span class="badge bg-gradient-${user.role === 'admin' ? 'danger' : 'info'}">${user.role.toUpperCase()}</span></p>
            <p><strong>Status:</strong> <span class="badge bg-gradient-${user.is_verified === 'true' ? 'success' : 'warning'}">${user.is_verified === 'true' ? 'Verified' : 'Unverified'}</span></p>
            <p><strong>Joined:</strong> ${formatDate(user.created_at)}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Company:</strong> ${user.company_name || '-'}</p>
            <p><strong>Representative:</strong> ${user.company_representative || '-'}</p>
            <p><strong>Phone:</strong> ${user.phone_number || '-'}</p>
            <p><strong>Emergency:</strong> ${user.emergency_phone || '-'}</p>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col-12">
            <p><strong>Address:</strong><br>${user.address || '-'}</p>
          </div>
        </div>
      `;

      document.getElementById('userDetailsContent').innerHTML = content;
      new bootstrap.Modal(document.getElementById('viewUserModal')).show();
    }

    // Edit user
    function editUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      document.getElementById('editUserId').value = user.id;
      document.getElementById('editEmail').value = user.email;
      document.getElementById('editCompanyName').value = user.company_name || '';
      document.getElementById('editAddress').value = user.address || '';
      document.getElementById('editPhoneNumber').value = user.phone_number || '';
      document.getElementById('editCompanyRepresentative').value = user.company_representative || '';
      document.getElementById('editEmergencyPhone').value = user.emergency_phone || '';

      new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }

    // Save user changes
    document.getElementById('saveUserBtn').addEventListener('click', async () => {
      const userId = document.getElementById('editUserId').value;
      const userData = {
        email: document.getElementById('editEmail').value,
        company_name: document.getElementById('editCompanyName').value,
        address: document.getElementById('editAddress').value,
        phone_number: document.getElementById('editPhoneNumber').value,
        company_representative: document.getElementById('editCompanyRepresentative').value,
        emergency_phone: document.getElementById('editEmergencyPhone').value
      };

      try {
        await api.updateUser(userId, userData);
        showToast('User updated successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
        loadUsers();
      } catch (error) {
        showToast(error.message || 'Failed to update user', 'error');
      }
    });

    // Delete user
    async function deleteUser(userId, email) {
      if (!confirm(`Are you sure you want to delete user "${email}"? This action cannot be undone.`)) {
        return;
      }

      try {
        await api.deleteUser(userId);
        showToast('User deleted successfully', 'success');
        loadUsers();
      } catch (error) {
        showToast(error.message || 'Failed to delete user', 'error');
      }
    }

    // Filter users
    document.querySelectorAll('[data-filter]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');

        const filter = e.target.dataset.filter;
        let filtered = allUsers;

        if (filter === 'admin') {
          filtered = allUsers.filter(u => u.role === 'admin');
        } else if (filter === 'client') {
          filtered = allUsers.filter(u => u.role === 'client');
        } else if (filter === 'verified') {
          filtered = allUsers.filter(u => u.is_verified === 'true');
        } else if (filter === 'unverified') {
          filtered = allUsers.filter(u => u.is_verified === 'false');
        }

        displayUsers(filtered);
      });
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', debounce((e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allUsers.filter(user =>
        user.email.toLowerCase().includes(searchTerm) ||
        (user.company_name && user.company_name.toLowerCase().includes(searchTerm)) ||
        (user.company_representative && user.company_representative.toLowerCase().includes(searchTerm))
      );
      displayUsers(filtered);
    }, 300));

    // Load users on page load
    loadUsers();
  </script>
</body>

</html>